<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="MobileOptimized" content="176"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="robots" content="noindex,nofollow"/>
    <link rel="stylesheet" href="style.css">
    <title>SIBA</title>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }
        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();
    </script>
    <!-- jQuery and JS bundle w/ Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="container">
    <form id="taskForm">
        <div class="taskCard">
            <input type="text" id="taskName" placeholder="Введите название задачи">
            <label class="inline-checkbox">
                <input type="checkbox" id="important">
                Важно
            </label>
            <label class="inline-checkbox">
                <input type="checkbox" id="repeat">
                Повторять
            </label>
        </div>
        <div class="taskCard">
            <label for="dateTime">Дата/Время</label>
            <input type="datetime-local" id="dateTime">
            <div class="form-group" style="display:none;" id="selectFrequency">
                <label for="frequency">Периодичность</label>
                <select id="frequency">
                    <option>Ежедневно</option>
                    <option>Еженедельно</option>
                    <option>Ежемесячно</option>
                </select>
            </div>
            <div id="daysOfWeek" style="display:none">
                <label><input type="checkbox" name="days" value="MO">пн</label>
                <label><input type="checkbox" name="days" value="TU">вт</label>
                <label><input type="checkbox" name="days" value="WE">ср</label>
                <label><input type="checkbox" name="days" value="TH">чт</label>
                <label><input type="checkbox" name="days" value="FR">пт</label>
                <label><input type="checkbox" name="days" value="SA">сб</label>
                <label><input type="checkbox" name="days" value="SU">вс</label>
            </div>
        </div>
        <div class="taskCard">
            <input class="form-check-input" type="checkbox" value="" id="target">
            <label class="form-check-label" for="target">Цель</label>
            <div class="form-group" style="display:none;" id="targetValueGroup">
                <label for="targetValue">Количество</label>
                <input pattern="[0-9]*" type="text" id="targetValue" placeholder="Введите количество">
            </div>
            <div class="form-group" style="display:none;" id="valueTypeGroup">
                <label for="valueType">Тип значения</label>
                <select  id="valueType">
                    <option>раз</option>
                    <option>миллилитров</option>
                    <option>страниц</option>
                    <option>километров</option>
                    <option>штук</option>
                    <option>минут</option>
                    <option>часов</option>
                </select>
            </div>
        </div>
    </form>
</div>
<script>
    $("#frequency").change(function() {
        if ($(this).val() == "Еженедельно") {
            $("#daysOfWeek").show();
        } else {
            $("#daysOfWeek").hide();
            $('input[name="days"]').prop('checked', false);
        }
    });
    $("#frequency").change(function() {
        if ($(this).val() == "Ежемесячно") {
            $('#dateTime').prop('type', 'datetime-local');
        } else {
            $('#dateTime').prop('type', 'time');
        }
    });
    $('#repeat').change(function() {
        if(this.checked) {
            $('#dateTime').prop('type', 'time');
            $('#selectFrequency').show();
        } else {
            $('#dateTime').prop('type', 'datetime-local');
            $('#selectFrequency').hide();
        }
    });

    $('#target').change(function() {
        if(this.checked) {
            $('#targetValueGroup').show();
            $('#valueTypeGroup').show();
        } else {
            $('#targetValueGroup').hide();
            $('#valueTypeGroup').hide();
        }
    });
    window.addEventListener('load', () => {
        var now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        now.setMilliseconds(null)
        now.setSeconds(null)
        document.getElementById('dateTime').value = now.toISOString().slice(0, -1);
    });

    Telegram.WebApp.onEvent('mainButtonClicked', function(){
        const taskData = {
            taskName: $('#taskName').val(),
            important: $('#important').is(':checked'),
            dateTime: $('#dateTime').val(),
            repeat: $('#repeat').is(':checked'),
            frequency: $('#frequency').val(),
            target: $('#target').is(':checked'),
            targetValue: $('#targetValue').val(),
            valueType: $('#valueType').val(),
            days: $("input[name='days']:checked").map(function() {
                return this.value;
            }).get(),
        }

        tg.sendData(JSON.stringify(taskData));
        tg.close();

    });


</script>
<script src="app.js"></script>
</body>
</html>